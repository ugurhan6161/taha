<html><head><base href="/" />
<style>
    body { 
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }
    
    #game {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background-size: 100% 100%;
        background-repeat: repeat-x; /* Allow background to repeat horizontally */
    }
    
    #player {
        position: absolute;
        width: 90px;
        height: 60px;
        background-image: url('https://www.renk.gen.tr/images/fusya-rengi.jpg'); /* Update player image */
        background-size: contain;
        background-repeat: no-repeat;
        bottom: 60px;
        left: 20%;
        transform: translateX(-50%) rotate(90deg);
        transform-origin: center center;
        transition: transform 0.2s;
        z-index: 10;
        animation: float 2s infinite alternate;
    }
    
    .coin {
        position: absolute;
        width: 30px;
        height: 30px;
        background-image: url('https://i.ibb.co/S3X8Lcs/Ads-z-tasar-m-1.gif');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        animation: float 2s infinite alternate;
    }
    
    .enemy {
        position: absolute;
        width: 40px;
        height: 40px;
        background-image: url('https://i.ibb.co/02XwHVL/Ads-z-tasar-m.gif'); 
        background-size: contain; 
        background-repeat: no-repeat; 
        background-position: center; 
        border-radius: 5px;
        animation: float 2s infinite alternate;
    }

    .enemy-flying {
        position: absolute;
        width: 40px;
        height: 40px;
        background-image: url('https://i.ibb.co/02XwHVL/Ads-z-tasar-m.gif'); 
        background-size: contain; 
        background-repeat: no-repeat; 
        background-position: center; 
        border-radius: 5px;
        animation: flyingEnemy 4s infinite;

    }

    @keyframes flyingEnemy {
        0% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(0, 30px) rotate(0deg); }
        75% { transform: translate(0, -30px) rotate(0deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
    }

    .obstacle {
        position: absolute;
        width: 100px;  /* Increased from 60px */
        height: 100px; /* Increased from 60px */
        background-image: url('https://i.ibb.co/brNWkfx/Ads-z-tasar-m-2.png'); 
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        border-radius: 5px;
    }
    
    #score {
        position: fixed;
        top: 20px;
        left: 20px;
        color: white;
        font-size: 24px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        z-index: 100;
    }

    #timer {
        position: fixed;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 24px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        z-index: 100;
    }

    .ground-segment {
        position: absolute;
        bottom: 0;
        width: 100vw;
        height: 50px;
        background: #4b2810;
        background-image: linear-gradient(45deg, #3b1d08 25%, transparent 25%),
                          linear-gradient(-45deg, #3b1d08 25%, transparent 25%);
        background-size: 50px 50px;
    }

    .vertical-controls {
        position: fixed;
        left: 20px;
        bottom: 20px;
        display: none; /* Hide by default */
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
    }

    .vert-btn {
        width: 60px;
        height: 60px;
        background: rgba(255,255,255,0.5);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        user-select: none;
    }

    .fire-btn {
        position: fixed;
        right: 20px;
        bottom: 100px;
        width: 80px;
        height: 80px;
        background: rgba(255, 0, 0, 0.5);
        border-radius: 50%;
        display: none; /* Hide by default */
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        user-select: none;
    }

    .laser {
        position: absolute;
        height: 4px; /* Thin line */
        background: red;
        transform-origin: left center;
        box-shadow: 0 0 10px #ff0000;
        animation: laserGlow 0.2s infinite alternate;
        pointer-events: none;
    }

    @keyframes float {
        from { transform: translateY(0px) rotate(90deg); }
        to { transform: translateY(10px) rotate(90deg); }
    }

    @keyframes heartBeat {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    .life-lost {
        animation: heartBeat 0.5s ease-in-out;
        color: red;
    }

    @keyframes laserGlow {
        from { opacity: 0.8; }
        to { opacity: 1; }
    }
    
    #startButton:hover {
        transform: scale(1.1);
        background: #ff6666;
    }

    #levelsButton {
        padding: 15px 30px;
        font-size: 24px;
        background: #4444ff;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: transform 0.2s;
        margin-bottom: 20px;
    }

    #levelsButton:hover {
        transform: scale(1.1);
        background: #6666ff;
    }

    #levelsModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    #levelsModal .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 80%;
        max-width: 600px;
    }

    .levels-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .level-btn {
        padding: 15px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .level-btn.unlocked {
        background: #4444ff;
        color: white;
    }

    .level-btn.locked {
        background: #cccccc;
        color: #666666;
        cursor: not-allowed;
        position: relative;
    }

    .level-btn.locked::after {
        content: '🔒';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
    }

    .close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        background: none;
        border: none;
        color: #333;
        cursor: pointer;
    }

    #startMenu div {
        color: white;
        margin-top: 30px;
        text-align: center;
        line-height: 1.6;
        background: rgba(0,0,0,0.7);
        padding: 15px;
        border-radius: 10px;
    }

    #questionModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    #questionModal > div {
        background: white;
        padding: 30px;
        border-radius: 15px;
        min-width: 300px;
        max-width: 80%;
    }

    .answer-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .answer-btn {
        padding: 15px 20px;
        background: #4444ff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 18px;
    }

    .answer-btn:hover {
        background: #6666ff;
    }

    .level-start-screen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .level-start-screen div {
        text-align: center;
        color: white;
    }

    .level-start-screen button {
        padding: 15px 30px;
        font-size: 24px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s;
        display: block;
    }

    .level-start-screen button:hover {
        transform: scale(1.1);
        background: #ff6666;
    }

    .pause-button {
        position: fixed;
        top: 20px;
        right: 100px;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        z-index: 1000;
        display: none; /* Hide by default */
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .pause-button:hover {
        transform: scale(1.1);
    }

    .pause-modal {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 15px;
        text-align: center;
    }

    .menu-button {
        display: block;
        width: 200px;
        margin: 15px auto;
        padding: 15px;
        font-size: 18px;
        background: #4444ff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s, background 0.2s;
    }

    .menu-button:hover {
        transform: scale(1.05);
        background: #6666ff;
    }

    #pauseModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    #loadingTransition {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: url('https://i.ibb.co/vVMPBJQ/ezgif-com-cut.gif') center center no-repeat;
        background-size: 50% auto; /* Changed from 'cover' to '50% auto' to make the image smaller */
        background-color: rgba(0,0,0,0.8);
        z-index: 3000;
        display: none;
    }

    @keyframes celebrationPop {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        50% {
            transform: scale(1.2);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 0;
        }
    }

    .celebration-particle {
        position: fixed;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 9999;
    }

    #celebrationMessage {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 20px 40px;
        border-radius: 15px;
        font-size: 24px;
        color: #4444ff;
        z-index: 3000;
        animation: celebrationPop 1s forwards;
        text-align: center;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }
</style>
</head>
<body>
    <div id="loadingTransition"></div>
    <div id="levelsModal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2>Bölümler</h2>
            <div class="levels-grid">
                <!-- Levels will be added dynamically -->
            </div>
        </div>
    </div>
    <div id="startMenu" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); display: flex; flex-direction: column; 
        justify-content: flex-end; align-items: center; z-index: 1000;
        background-image: url('https://i.ibb.co/CW0H8MX/Ads-z-tasar-m.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;">
        <button id="startButton" style="padding: 15px 30px; font-size: 24px; 
            background: #ff4444; color: white; border: none; border-radius: 10px; 
            cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            transition: transform 0.2s;
            margin-bottom: 50px;">
            Oyunu Başlat
        </button>
        <button id="levelsButton">
            Bölümler
        </button>
    </div>
    <div id="game">
        <div id="score">Skor: <span id="scoreValue">0</span> | ❤️ <span id="livesDisplay">4</span></div>
        <div id="timer">
            Bölüm: <span id="levelDisplay">1</span> | Süre: <span id="timeDisplay">60</span>
        </div>
        <div id="player"></div>
        <div class="vertical-controls">
            <div class="vert-btn" id="upBtn">↑</div>
            <div class="vert-btn" id="downBtn">↓</div>
        </div>
        <div class="fire-btn">🔥</div>
    </div>

    <div id="questionModal">
        <div>
            <h2 id="questionText">Soru</h2>
            <div class="answer-options">
                <!-- Answer buttons will be added dynamically -->
            </div>
        </div>
    </div>

    <div id="levelStartScreen" class="level-start-screen" style="display: none;">
        <div style="text-align: center; color: white;">
            <h2>Bölüm 1</h2>
            <button id="startLevelButton" style="margin-top: 20px;">Bölümü Başlat</button>
        </div>
    </div>

    <div id="pauseModal" class="modal" style="display: none;">
        <div class="modal-content pause-modal">
            <h2>Oyun Duraklatıldı</h2>
            <button id="resumeButton" class="menu-button">Devam Et</button>
            <button id="mainMenuButton" class="menu-button">Ana Menü</button>
        </div>
    </div>

    <button id="pauseButton" class="pause-button">⏸️</button>
    <div id="celebrationMessage">Tebrikler! Doğru Cevap! 🎉</div>

<script>
let currentLevel = 1;
let levelTimer = 60; // 60 seconds per level
let levelInterval;
let questionBank = [
    {
        question: "2 + 2 = ?",
        answer: "4",
        options: ["3", "4", "5", "6"]
    },
    {
        question: "Başkentimiz neresidir?",
        answer: "ankara",
        options: ["istanbul", "ankara", "izmir", "bursa"]
    },
    {
        question: "5 x 5 = ?",
        answer: "25",
        options: ["20", "30", "25", "15"]
    },
    {
        question: "Türkiye'nin en büyük gölü hangisidir?",
        answer: "van",
        options: ["tuz", "van", "beyşehir", "eğirdir"]
    },
    {
        question: "3 + 7 = ?",
        answer: "10",
        options: ["8", "9", "10", "11"]
    },
    {
        question: "Dünya'nın uydusu nedir?",
        answer: "ay",
        options: ["güneş", "ay", "mars", "yıldız"]
    },
    {
        question: "12 - 5 = ?",
        answer: "7",
        options: ["6", "7", "8", "9"]
    },
    {
        question: "20 ÷ 4 = ?",
        answer: "5",
        options: ["4", "5", "6", "7"]
    },
    {
        question: "En sevdiğimiz renk nedir? (kırmızı beyaz)",
        answer: "kırmızı",
        options: ["mavi", "yeşil", "kırmızı", "sarı"]
    },
    {
        question: "9 + 9 = ?",
        answer: "18",
        options: ["16", "17", "18", "19"]
    }
];

const difficultySettings = {
    1: { // Level 1 - Base difficulty
        gameSpeed: 3,
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    2: { // Level 2
        gameSpeed: 3, // Changed from 4 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    3: { // Level 3
        gameSpeed: 3, // Changed from 4.5 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    4: { // Level 4
        gameSpeed: 3, // Changed from 5 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    5: { // Level 5
        gameSpeed: 3, // Changed from 5.5 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    6: { // Level 6
        gameSpeed: 3, // Changed from 6 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    7: { // Level 7
        gameSpeed: 3, // Changed from 6.5 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    8: { // Level 8
        gameSpeed: 3, // Changed from 7 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    9: { // Level 9
        gameSpeed: 3, // Changed from 7.5 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    },
    10: { // Level 10
        gameSpeed: 3, // Changed from 8 to 3
        coinFrequency: 300,
        enemyFrequency: 500,
        flyingEnemyFrequency: 700,
        obstacleFrequency: 400
    }
};

let lives = 4;
let isInvulnerable = false;
let gameStarted = false;
let isPaused = false; // New variable to control pause state
const pauseButton = document.getElementById('pauseButton');
const pauseModal = document.getElementById('pauseModal');
const resumeButton = document.getElementById('resumeButton');
const mainMenuButton = document.getElementById('mainMenuButton');

const startMenu = document.getElementById('startMenu');
const startButton = document.getElementById('startButton');
const levelsButton = document.getElementById('levelsButton');

const player = document.getElementById('player');
const game = document.getElementById('game');
const scoreElement = document.getElementById('scoreValue');
const livesDisplay = document.getElementById('livesDisplay');
const upBtn = document.getElementById('upBtn');
const downBtn = document.getElementById('downBtn');
const fireBtn = document.querySelector('.fire-btn');

let autoMovingRight = true; // New variable to control auto movement
let playerImageDefault = 'https://www.renk.gen.tr/images/fusya-rengi.jpg'; // Updated player image
let playerImageJumping = 'https://www.renk.gen.tr/images/fusya-rengi.jpg'; // Updated player image

let playerX = window.innerWidth * 0.2; // Change from window.innerWidth / 2 to window.innerWidth * 0.2
let playerY = 50;
let score = 0;
let gameSpeed = 3;
let worldOffset = 0;
let facing = 'right';
let gameElements = [];
let movingUp = false;
let movingDown = false;
let lasers = [];

// New variable for background movement
let backgroundOffset = 0;

// Initialize unlockedLevels
let unlockedLevels = new Set([1]); // Start with only level 1 unlocked

function createGround() {
    for(let i = 0; i < 3; i++) {
        const ground = document.createElement('div');
        ground.className = 'ground-segment';
        ground.style.left = (i * window.innerWidth) + 'px';
        game.appendChild(ground);
        gameElements.push({element: ground, type: 'ground', x: i * window.innerWidth});
    }
}

// Update the level background function
function updateLevelBackground() {
    const gameDiv = document.getElementById('game');
    if(currentLevel <= 2) {
        gameDiv.style.backgroundImage = "url('https://images.freeimages.com/365/images/istock/previews/8787/87879565-game-background.jpg?fmt=webp&h=350')";
    } else if(currentLevel <= 4) {
        gameDiv.style.backgroundImage = "url('https://img.freepik.com/free-vector/magic-portal-alien-planet-space-landscape_107791-6249.jpg?t=st=1734452322~exp=1734455922~hmac=ab91da2df7a73b5c8662c06a8f318a9c0f45acf5b8537e06d60b0a605086750a&w=1380')";
    } else if(currentLevel <= 6) {
        gameDiv.style.backgroundImage = "url('https://img.freepik.com/free-vector/cosmic-background-alien-planet-deserted-landscape-with-mountains_107791-6400.jpg?t=st=1734452358~exp=1734455958~hmac=bbc4f7b0a0e1c1a4071a3204b8d93312ab6d662eb9ddb1512d88157837a36d46&w=1380')";
        } else if(currentLevel <= 7) {
        gameDiv.style.backgroundImage = "url('https://img.freepik.com/free-vector/alien-space-planet-landscape-background-brook-crack-mars-desert-vector-game-illustration-martian-ground-surface-terrain-blue-stream-fantasy-outer-orange-universe-scene-dust-environment_107791-24521.jpg?t=st=1734452389~exp=1734455989~hmac=aebfa28cc9b12dff108f931a3bced17f3439e9746f6b0e763d4a64856160e608&w=1380')";
        } else if(currentLevel <= 8) {
        gameDiv.style.backgroundImage = "url('https://img.freepik.com/free-vector/alien-night-planet-landscape-space-game-background_107791-12914.jpg?t=st=1734452423~exp=1734456023~hmac=0c60e54f441ef14c18ca9b85e8931c24a3534094d2163fd7ae1efd0ccf4c2ce0&w=1380')";
        } else if(currentLevel <= 9) {
        gameDiv.style.backgroundImage = "url('https://img.freepik.com/free-vector/fantastic-landscape-with-ledge-planet-sky_107791-13221.jpg?t=st=1734452454~exp=1734456054~hmac=a6814e850b02be92dd6cc91a0171797e5efffa6de25aad6d7ce73e9e5fda6e89&w=1380')";
        } else if(currentLevel <= 10) {
        gameDiv.style.backgroundImage = "url('https://img.freepik.com/free-vector/purple-alien-space-planet-game-cartoon-background_107791-19696.jpg?t=st=1734452262~exp=1734455862~hmac=112d5014ba8924cbd6f3931498c90dabb071e573033b2b7799b69c7fc7ffa9f3&w=1380')";
    } else {
        gameDiv.style.background = "linear-gradient(to bottom, #87CEEB, #4682B4)";
    }
}

function showLoadingTransition() {
    const transition = document.getElementById('loadingTransition');
    transition.style.display = 'block';
    
    return new Promise(resolve => {
        setTimeout(() => {
            transition.style.display = 'none';
            resolve();
        }, 2000);
    });
}

function startGame() {
    // Initialize the game
    createGround();
    startLevel();
}

// Update the moveWorld function to handle backgrounds for all levels
function moveWorld() {
    const currentSettings = difficultySettings[currentLevel];
    gameSpeed = currentSettings.gameSpeed;

    // Move and loop background
    backgroundOffset += gameSpeed;
    if (currentLevel <= 4) { // Changed from <= 2 to <= 4 to include levels 3-4
        const gameDiv = document.getElementById('game');
        gameDiv.style.backgroundPosition = `-${backgroundOffset}px center`;
    }

    gameElements.forEach(item => {
        item.x -= gameSpeed;
        item.element.style.left = item.x + 'px';
        
        if(item.x < -window.innerWidth) {
            if(item.type === 'ground') {
                item.x += window.innerWidth * 3;
                item.element.style.left = item.x + 'px';
            } else {
                item.element.remove();
                gameElements = gameElements.filter(e => e !== item);
            }
        }
    });

    // Use difficulty settings for spawning elements
    if(worldOffset % currentSettings.coinFrequency === 0) createCoin();
    if(worldOffset % currentSettings.enemyFrequency === 0) createEnemy();
    if(worldOffset % currentSettings.flyingEnemyFrequency === 0) createFlyingEnemy();
    if(worldOffset % currentSettings.obstacleFrequency === 0) createObstacle();
}

// Reset background position in the resetLevel function
function resetLevel() {
    // Reset background position
    backgroundOffset = 0;
    const gameDiv = document.getElementById('game');
    gameDiv.style.backgroundPosition = '0 center';
    
    // Rest of the existing resetLevel code...
    gameElements.forEach(item => {
        if(item.element && item.element.parentNode) {
            item.element.remove();
        }
    });
    gameElements = [];

    lasers.forEach(laser => {
        if(laser.element && laser.element.parentNode) {
            laser.element.remove();
        }
    });
    lasers = [];

    playerX = window.innerWidth * 0.2;
    playerY = 50;
    player.style.left = playerX + 'px';
    player.style.bottom = playerY + 'px';
    player.style.backgroundImage = `url('${playerImageDefault}')`;
    player.style.opacity = '1';
    
    worldOffset = 0;
    isInvulnerable = false;
    
    createGround();
    updateLevelBackground();
    
    startLevel();
    
    gameStarted = true;
}

function celebrate() {
    // Show celebration message
    const message = document.getElementById('celebrationMessage');
    message.style.display = 'block';
    
    // Create confetti particles
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
    for(let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'celebration-particle';
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        
        // Random starting position near the top
        const startX = Math.random() * window.innerWidth;
        particle.style.left = startX + 'px';
        particle.style.top = '0px';
        
        document.body.appendChild(particle);
        
        // Animate particle
        const angle = Math.random() * Math.PI * 2;
        const velocity = 5 + Math.random() * 5;
        const lifetime = 1000 + Math.random() * 1000;
        
        let posX = startX;
        let posY = 0;
        let time = 0;
        
        const animate = () => {
            time += 16;
            posX += Math.cos(angle) * velocity;
            posY += Math.sin(angle) * velocity + time * 0.02;
            
            particle.style.left = posX + 'px';
            particle.style.top = posY + 'px';
            
            if(time < lifetime) {
                requestAnimationFrame(animate);
            } else {
                particle.remove();
            }
        };
        
        requestAnimationFrame(animate);
    }
    
    // Remove celebration message after animation
    setTimeout(() => {
        message.style.display = 'none';
    }, 2000);
}

// Update checkAnswer function to include celebration
function checkAnswer(selectedAnswer) {
    const correctAnswer = questionBank[currentLevel - 1].answer.toLowerCase();
    
    if(selectedAnswer.toLowerCase() === correctAnswer) {
        celebrate(); // Add celebration effect
        
        setTimeout(() => {
            document.getElementById('questionModal').style.display = 'none';
            
            if(currentLevel < 10) {
                currentLevel++;
                unlockedLevels.add(currentLevel); // Unlock next level
                showLevelStartScreen();
            } else {
                alert('Tebrikler! Tüm bölümleri tamamladınız!\nToplam Skor: ' + score);
                location.reload();
            }
        }, 2000); // Wait for celebration to finish
    } else {
        alert('Yanlış cevap! Tekrar deneyin.');
    }
}

// Update showLevelStartScreen function to show controls
async function showLevelStartScreen() {
    const levelStartScreen = document.getElementById('levelStartScreen');
    const startLevelButton = document.getElementById('startLevelButton');
    
    // Make sure elements exist
    if (!levelStartScreen || !startLevelButton) {
        console.error('Required elements not found');
        return;
    }
    
    // Reset display style
    levelStartScreen.style.display = 'flex';
    startLevelButton.style.display = 'block';
    
    // Update button text
    startLevelButton.textContent = `Bölüm ${currentLevel}'i Başlat`;
    
    startLevelButton.onclick = async () => {
        await showLoadingTransition();
        levelStartScreen.style.display = 'none';
        // Show controls when starting level
        document.getElementById('pauseButton').style.display = 'flex';
        document.querySelector('.vertical-controls').style.display = 'flex';
        document.querySelector('.fire-btn').style.display = 'flex';
        resetLevel();
        gameLoop();
    };
}

// Update the levels modal click handler
function showLevelsModal() {
    const levelsModal = document.getElementById('levelsModal');
    const levelsGrid = levelsModal.querySelector('.levels-grid');
    
    // Clear existing content
    levelsGrid.innerHTML = '';
    
    // Create level buttons
    for(let i = 1; i <= 10; i++) {
        const levelBtn = document.createElement('button');
        levelBtn.className = `level-btn ${unlockedLevels.has(i) ? 'unlocked' : 'locked'}`;
        levelBtn.textContent = `Bölüm ${i}`;
        
        if(unlockedLevels.has(i)) {
            levelBtn.onclick = () => {
                currentLevel = i;
                levelsModal.style.display = 'none';
                startMenu.style.display = 'none';
                showLevelStartScreen();
            };
        }
        
        levelsGrid.appendChild(levelBtn);
    }
    
    levelsModal.style.display = 'flex';
}

function handleTouchStart(e, action) {
    e.preventDefault();
    action();
}

function handleButtonDown(action) {
    action();
}

function handleButtonUp(action) {
    action();
}

// Touch controls
upBtn.addEventListener('touchstart', (e) => handleTouchStart(e, () => { movingUp = true; }));
upBtn.addEventListener('touchend', (e) => handleTouchStart(e, () => { movingUp = false; }));
downBtn.addEventListener('touchstart', (e) => handleTouchStart(e, () => { movingDown = true; }));
downBtn.addEventListener('touchend', (e) => handleTouchStart(e, () => { movingDown = false; }));
fireBtn.addEventListener('touchstart', (e) => handleTouchStart(e, shootLaser));

// Mouse controls
upBtn.addEventListener('mousedown', () => handleButtonDown(() => { movingUp = true; }));
upBtn.addEventListener('mouseup', () => handleButtonUp(() => { movingUp = false; }));
downBtn.addEventListener('mousedown', () => handleButtonDown(() => { movingDown = true; }));
downBtn.addEventListener('mouseup', () => handleButtonUp(() => { movingDown = false; }));
fireBtn.addEventListener('mousedown', () => handleButtonDown(shootLaser));

// Keyboard controls
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'ArrowUp':
            movingUp = true;
            break;
        case 'ArrowDown':
            movingDown = true;
            break;
        case 'f':
        case 'F':
            shootLaser();
            break;
    }
});

document.addEventListener('keyup', (e) => {
    switch(e.key) {
        case 'ArrowUp':
            movingUp = false;
            break;
        case 'ArrowDown':
            movingDown = false;
            break;
    }
});

function updatePlayerPosition() {
    // Auto move right
    if (autoMovingRight) {
        if(facing === 'left') {
            player.style.transform = 'translateX(-50%) scaleX(1) rotate(90deg)';
            facing = 'right';
        }
        
        worldOffset += gameSpeed;
        moveWorld();
        playerX = window.innerWidth * 0.2; // Keep player at 20% from left
    }

    // Vertical movement remains the same
    if (movingUp) {
        playerY = Math.min(window.innerHeight - 100, playerY + 5);
    }
    if (movingDown) {
        playerY = Math.max(50, playerY - 5);
    }

    player.style.left = playerX + 'px';
    player.style.bottom = playerY + 'px';
}

function createCoin() {
    const coin = document.createElement('div');
    coin.className = 'coin';
    const x = window.innerWidth + Math.random() * 200;
    coin.style.left = x + 'px';
    coin.style.bottom = (Math.random() * 150 + 100) + 'px';
    game.appendChild(coin);
    gameElements.push({element: coin, type: 'coin', x: x});
}

function createEnemy() {
    const enemy = document.createElement('div');
    enemy.className = 'enemy';
    const x = window.innerWidth + Math.random() * 200;
    enemy.style.left = x + 'px';
    enemy.style.bottom = '50px';
    game.appendChild(enemy);
    gameElements.push({element: enemy, type: 'enemy', x: x});
}

function createFlyingEnemy() {
    const enemy = document.createElement('div');
    enemy.className = 'enemy-flying';
    const x = window.innerWidth + Math.random() * 200;
    // Random height between 100 and 400 pixels
    const y = Math.random() * 300 + 100;
    enemy.style.left = x + 'px';
    enemy.style.bottom = y + 'px';
    game.appendChild(enemy);
    gameElements.push({element: enemy, type: 'enemy', x: x, isFlying: true});
}

function createObstacle() {
    const obstacle = document.createElement('div');
    obstacle.className = 'obstacle';
    const x = window.innerWidth + Math.random() * 200;
    // Randomly position obstacles at different heights
    const y = Math.random() < 0.5 ? 50 : 50; // Will create obstacles at two different heights
    obstacle.style.left = x + 'px';
    obstacle.style.bottom = y + 'px';
    game.appendChild(obstacle);
    gameElements.push({element: obstacle, type: 'obstacle', x: x});
}

function shootLaser() {
    const laser = document.createElement('div');
    laser.className = 'laser';
    
    // Position laser at player's eyes
    const playerRect = player.getBoundingClientRect();
    const eyeLevel = playerRect.right + playerRect.height * 0.3; // Position at ~30% of player height
    
    // Find closest enemy
    let closestEnemy = null;
    let closestDistance = Infinity;
    
    gameElements.forEach(item => {
        if(item.type === 'enemy' || item.isFlying) {
            const enemyRect = item.element.getBoundingClientRect();
            const enemyCenter = {
                x: enemyRect.left + enemyRect.width/2,
                y: enemyRect.top + enemyRect.height/2
            };
            const distance = Math.hypot(
                enemyCenter.x - playerX,
                enemyCenter.y - eyeLevel
            );
            
            if(distance < closestDistance) {
                closestDistance = distance;
                closestEnemy = {
                    x: enemyCenter.x,
                    y: enemyCenter.y
                };
            }
        }
    });
    
    laser.style.top = eyeLevel + 'px';
    laser.style.left = playerX + 'px';
    
    let angle = 0;
    let targetX = playerX + (facing === 'right' ? 1000 : -1000);
    let targetY = eyeLevel;
    
    if(closestEnemy) {
        // Calculate angle to enemy
        const dx = closestEnemy.x - playerX;
        const dy = closestEnemy.y - eyeLevel;
        angle = Math.atan2(dy, dx);
        targetX = closestEnemy.x;
        targetY = closestEnemy.y;
    } else {
        // Default horizontal angle based on facing direction
        angle = facing === 'right' ? 0 : Math.PI;
    }
    
    // Convert angle to degrees and set transform
    const degrees = angle * (180/Math.PI);
    laser.style.transform = `rotate(${degrees}deg)`;
    
    game.appendChild(laser);
    
    const laserObj = {
        element: laser,
        x: playerX,
        y: eyeLevel,
        angle: angle,
        targetX: targetX,
        targetY: targetY,
        speed: 15
    };
    
    lasers.push(laserObj);
}

function updateLasers() {
    // Get current player rectangle once at start of update
    const playerRect = player.getBoundingClientRect();
    
    for(let i = lasers.length - 1; i >= 0; i--) {
        const laser = lasers[i];
        
        // Calculate new position using angle
        laser.x += Math.cos(laser.angle) * laser.speed;
        laser.y += Math.sin(laser.angle) * laser.speed;
        
        laser.element.style.left = laser.x + 'px';
        laser.element.style.top = laser.y + 'px';
        
        // Set laser length based on distance traveled
        const distance = Math.hypot(
            laser.x - playerX,
            laser.y - (playerRect.top + playerRect.height * 0.3)
        );
        laser.element.style.width = Math.min(distance, 20) + 'px';
        
        // Check for collision with enemies
        const laserRect = laser.element.getBoundingClientRect();
        
        gameElements.forEach(item => {
            if(item.type === 'enemy' || item.isFlying) {
                const enemyRect = item.element.getBoundingClientRect();
                if(isColliding(laserRect, enemyRect)) {
                    // Remove enemy
                    item.element.remove();
                    gameElements = gameElements.filter(e => e !== item);
                    
                    // Remove laser
                    laser.element.remove();
                    lasers.splice(i, 1);
                    
                    // Add score
                    score += 20;
                    scoreElement.textContent = score;
                }
            }
        });
        
        // Remove laser if it goes off screen
        if(laser.x < 0 || laser.x > window.innerWidth || 
           laser.y < 0 || laser.y > window.innerHeight) {
            laser.element.remove();
            lasers.splice(i, 1);
        }
    }
}

function gameLoop() {
    if (!gameStarted || isPaused) {
        requestAnimationFrame(gameLoop);
        return;
    }
    
    updatePlayerPosition();
    updateLasers();  
    
    const playerRect = player.getBoundingClientRect();
    
    // Create a copy of gameElements to avoid modification during iteration
    [...gameElements].forEach(item => {
        if(item.type === 'ground') return;
        
        if(!item.element || !item.element.parentNode) {
            gameElements = gameElements.filter(e => e !== item);
            return;
        }
        
        const itemRect = item.element.getBoundingClientRect();
        if(isColliding(playerRect, itemRect)) {
            if(item.type === 'coin') {
                score += 10;
                scoreElement.textContent = score;
                item.element.remove();
                gameElements = gameElements.filter(e => e !== item);
            } else if(item.type === 'enemy' || item.isFlying) {
                if(movingUp) {
                    score += 20;
                    scoreElement.textContent = score;
                    item.element.remove();
                    gameElements = gameElements.filter(e => e !== item);
                } else if(!isInvulnerable) {
                    loseLife();
                }
            } else if(item.type === 'obstacle') {
                if(!movingUp && !isInvulnerable) {
                    loseLife();
                }
            }
        }
    });
    
    requestAnimationFrame(gameLoop);
}

function isColliding(rect1, rect2) {
    return !(rect1.right < rect2.left || 
             rect1.left > rect2.right || 
             rect1.bottom < rect2.top || 
             rect1.top > rect2.bottom);
}

function startLevel() {
    if (levelInterval) {
        clearInterval(levelInterval);
    }
    
    levelTimer = 60;
    updateLevelBackground();
    updateTimer();
    
    // Add interval for timer countdown
    levelInterval = setInterval(() => {
        levelTimer--;
        updateTimer();
        
        if (levelTimer <= 0) {
            clearInterval(levelInterval);
            completeLevel();
        }
    }, 1000);
}

function updateTimer() {
    document.getElementById('timeDisplay').textContent = levelTimer;
    document.getElementById('levelDisplay').textContent = currentLevel;
}

function completeLevel() {
    clearInterval(levelInterval);
    gameStarted = false;
    
    // Make player fly up with animation
    const flyInterval = setInterval(() => {
        playerY += 10;
        player.style.bottom = playerY + 'px';
        
        if(playerY > window.innerHeight) {
            clearInterval(flyInterval);
            setTimeout(() => {
                showQuestion();
            }, 500);
        }
    }, 50);
}

function showQuestion() {
    const questionModal = document.getElementById('questionModal');
    const questionText = document.getElementById('questionText');
    const answerOptions = document.querySelector('.answer-options');
    
    // Clear previous options
    answerOptions.innerHTML = '';
    
    // Get current question
    const currentQuestion = questionBank[currentLevel - 1];
    if (!currentQuestion) {
        alert('Tebrikler! Tüm bölümleri tamamladınız!\nToplam Skor: ' + score);
        location.reload();
        return;
    }
    
    questionText.textContent = currentQuestion.question;
    
    // Shuffle options
    const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
    
    // Create option buttons
    shuffledOptions.forEach(option => {
        const button = document.createElement('button');
        button.className = 'answer-btn';
        button.textContent = option;
        button.onclick = () => checkAnswer(option);
        answerOptions.appendChild(button);
    });
    
    // Show the modal
    questionModal.style.display = 'flex';
}

// Modify the checkAnswer function to unlock next level
function checkAnswer(selectedAnswer) {
    const correctAnswer = questionBank[currentLevel - 1].answer.toLowerCase();
    
    if(selectedAnswer.toLowerCase() === correctAnswer) {
        celebrate(); // Add celebration effect
        
        setTimeout(() => {
            document.getElementById('questionModal').style.display = 'none';
            
            if(currentLevel < 10) {
                currentLevel++;
                unlockedLevels.add(currentLevel); // Unlock next level
                showLevelStartScreen();
            } else {
                alert('Tebrikler! Tüm bölümleri tamamladınız!\nToplam Skor: ' + score);
                location.reload();
            }
        }, 2000); // Wait for celebration to finish
    } else {
        alert('Yanlış cevap! Tekrar deneyin.');
    }
}

// Add this function after the other function definitions
function loseLife() {
    if (isInvulnerable) return;
    
    lives--;
    livesDisplay.textContent = lives;
    livesDisplay.classList.add('life-lost');
    
    // Remove animation class after animation completes
    setTimeout(() => {
        livesDisplay.classList.remove('life-lost');
    }, 500);

    // Make player invulnerable temporarily
    isInvulnerable = true;
    player.style.opacity = '0.5';

    // Remove invulnerability after 2 seconds
    setTimeout(() => {
        isInvulnerable = false;
        player.style.opacity = '1';
    }, 2000);

    // Check if game over
    if (lives <= 0) {
        gameStarted = false;
        player.style.backgroundImage = "url('https://i.ibb.co/jrdXJ4n/ezgif-com-cut-1.gif')";
        player.style.transition = "all 2s ease-in";
        
        // Make player fall and fade away
        let fallInterval = setInterval(() => {
            if (playerY > -200) { // Continue falling below ground
                playerY -= 5;
                player.style.bottom = playerY + 'px';
                
                // Gradually fade out as falling
                const opacity = Math.max(0, (playerY + 200) / 250); // Calculate opacity based on position
                player.style.opacity = opacity;
            } else {
                clearInterval(fallInterval);
                player.style.display = 'none'; // Hide completely
                setTimeout(() => {
                    alert('Oyun Bitti!\nToplam Skor: ' + score);
                    location.reload();
                }, 500);
            }
        }, 50);
    }
}

// Add event listeners for pause functionality
pauseButton.addEventListener('click', () => {
    isPaused = true;
    pauseModal.style.display = 'flex';
});

resumeButton.addEventListener('click', () => {
    isPaused = false;
    pauseModal.style.display = 'none';
});

mainMenuButton.addEventListener('click', () => {
    location.reload(); // Reload the page to return to main menu
});

// Fix start button functionality
startButton.addEventListener('click', async () => {
    await showLoadingTransition();
    startMenu.style.display = 'none';
    document.getElementById('pauseButton').style.display = 'flex';
    document.querySelector('.vertical-controls').style.display = 'flex';
    document.querySelector('.fire-btn').style.display = 'flex';
    resetLevel();
    gameStarted = true;
    gameLoop();
});

// Add event listener for levels button after the startButton listener
levelsButton.addEventListener('click', () => {
    showLevelsModal();
});

// Add the missing event listener for closing the levels modal
document.querySelector('.close-modal').addEventListener('click', () => {
    document.getElementById('levelsModal').style.display = 'none';
});

// Update initGame function to ensure proper initialization
function initGame() {
    gameStarted = false;
    isPaused = false;
    score = 0;
    currentLevel = 1;
    lives = 4;
    unlockedLevels = new Set([1]); // Start with only level 1 unlocked
    
    // Hide game controls initially
    document.getElementById('pauseButton').style.display = 'none';
    document.querySelector('.vertical-controls').style.display = 'none';
    document.querySelector('.fire-btn').style.display = 'none';
    
    // Show start menu
    startMenu.style.display = 'flex';
    
    // Reset score display
    scoreElement.textContent = '0';
    livesDisplay.textContent = '4';
}

// Call initGame when the page loads
window.addEventListener('load', initGame);
</script>
</body></html>
